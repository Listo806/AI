<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard Test - Milestone 3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            margin-bottom: 30px;
            color: #333;
        }
        .dashboard-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        .dashboard-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .list {
            max-height: 600px;
            overflow-y: auto;
        }
        .list-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }
        .list-item:hover {
            background: #f9f9f9;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }
        .item-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        .item-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }
        .status-contacted {
            background: #fef3c7;
            color: #92400e;
        }
        .status-qualified {
            background: #d1fae5;
            color: #065f46;
        }
        .status-converted {
            background: #d1fae5;
            color: #065f46;
        }
        .status-lost {
            background: #fee2e2;
            color: #991b1b;
        }
        .status-published {
            background: #d1fae5;
            color: #065f46;
        }
        .status-draft {
            background: #e5e7eb;
            color: #4b5563;
        }
        .item-details {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .item-meta {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        button {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        button:hover {
            background: #1d4ed8;
        }
        button.secondary {
            background: #6b7280;
        }
        .refresh-btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        @media (max-width: 1024px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ‘¤ Agent Dashboard - Milestone 3</h1>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div class="dashboard-header">
            <div>
                <h2>Dashboard Overview</h2>
                <p id="userInfo" style="color: #666; margin-top: 5px;">Not authenticated</p>
            </div>
            <button onclick="refreshDashboard()" class="refresh-btn">Refresh</button>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="dashboard-content">
            <!-- Leads Section -->
            <div class="section">
                <div class="section-header">
                    <h2>Incoming Leads</h2>
                </div>
                <div class="filter-controls">
                    <select id="leadStatusFilter" onchange="filterLeads()">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="qualified">Qualified</option>
                        <option value="converted">Converted</option>
                        <option value="lost">Lost</option>
                    </select>
                    <input type="text" id="leadSearch" placeholder="Search leads..." oninput="searchLeads()" style="flex: 1;">
                </div>
                <div class="list" id="leadsList">
                    <div class="loading">Loading leads...</div>
                </div>
            </div>

            <!-- Properties Section -->
            <div class="section">
                <div class="section-header">
                    <h2>Assigned Listings</h2>
                </div>
                <div class="filter-controls">
                    <select id="propertyStatusFilter" onchange="filterProperties()">
                        <option value="">All Statuses</option>
                        <option value="published">Published</option>
                        <option value="draft">Draft</option>
                        <option value="sold">Sold</option>
                        <option value="rented">Rented</option>
                    </select>
                    <input type="text" id="propertySearch" placeholder="Search properties..." oninput="searchProperties()" style="flex: 1;">
                </div>
                <div class="list" id="propertiesList">
                    <div class="loading">Loading properties...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/api-client.js"></script>
    <script type="module" src="js/auth-service.js"></script>
    <script type="module" src="js/agent-dashboard.js"></script>
    <script type="module">
        // Initialize services
        const apiClient = new ApiClient('http://localhost:3000/api');
        const authService = new AuthService(apiClient);
        let dashboard = null;

        // Make available globally
        window.apiClient = apiClient;
        window.authService = authService;

        // Initialize dashboard
        async function initDashboard() {
            if (!authService.isAuthenticated()) {
                showError('Please login first. Use auth-test.html to login, or set tokens in console.');
                updateUserInfo();
                return;
            }

            try {
                dashboard = new AgentDashboard(apiClient, authService);
                await dashboard.loadDashboard();
                renderDashboard();
            } catch (error) {
                showError(`Failed to load dashboard: ${error.message}`);
            }
        }

        function renderDashboard() {
            if (!dashboard) return;

            const stats = dashboard.getStats();
            renderStats(stats);
            renderLeads(dashboard.leads);
            renderProperties(dashboard.properties);
            updateUserInfo();
        }

        function renderStats(stats) {
            const container = document.getElementById('statsGrid');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value">${stats.totalLeads}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">New Leads</div>
                    <div class="stat-value">${stats.newLeads}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Qualified</div>
                    <div class="stat-value">${stats.qualifiedLeads}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Converted</div>
                    <div class="stat-value">${stats.convertedLeads}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Properties</div>
                    <div class="stat-value">${stats.totalProperties}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Published</div>
                    <div class="stat-value">${stats.publishedProperties}</div>
                </div>
            `;
        }

        function renderLeads(leads) {
            const container = document.getElementById('leadsList');
            
            if (leads.length === 0) {
                container.innerHTML = '<div class="empty-state">No leads found</div>';
                return;
            }

            container.innerHTML = leads.map(lead => {
                const statusClass = `status-${lead.status}`;
                const date = new Date(lead.createdAt).toLocaleDateString();
                
                return `
                    <div class="list-item">
                        <div class="item-header">
                            <div class="item-title">${lead.name || 'Unnamed Lead'}</div>
                            <span class="item-status ${statusClass}">${lead.status}</span>
                        </div>
                        <div class="item-details">
                            ${lead.email ? `<div>ðŸ“§ ${lead.email}</div>` : ''}
                            ${lead.phone ? `<div>ðŸ“ž ${lead.phone}</div>` : ''}
                            ${lead.notes ? `<div style="margin-top: 5px; font-style: italic;">${lead.notes.substring(0, 100)}${lead.notes.length > 100 ? '...' : ''}</div>` : ''}
                        </div>
                        <div class="item-meta">
                            ${lead.source ? `Source: ${lead.source} â€¢ ` : ''}Created: ${date}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderProperties(properties) {
            const container = document.getElementById('propertiesList');
            
            if (properties.length === 0) {
                container.innerHTML = '<div class="empty-state">No properties found</div>';
                return;
            }

            container.innerHTML = properties.map(property => {
                const statusClass = `status-${property.status}`;
                const date = new Date(property.createdAt).toLocaleDateString();
                const price = property.price ? `$${property.price.toLocaleString()}` : 'Price not set';
                const location = [property.address, property.city, property.state].filter(Boolean).join(', ') || 'Location not specified';
                
                return `
                    <div class="list-item">
                        <div class="item-header">
                            <div class="item-title">${property.title || 'Untitled Property'}</div>
                            <span class="item-status ${statusClass}">${property.status}</span>
                        </div>
                        <div class="item-details">
                            <div style="font-weight: 600; color: #2563eb; margin-bottom: 5px;">${price}</div>
                            <div>${location}</div>
                            ${property.bedrooms || property.bathrooms ? `<div style="margin-top: 5px;">${property.bedrooms || ''} bed${property.bedrooms !== 1 ? 's' : ''} â€¢ ${property.bathrooms || ''} bath${property.bathrooms !== 1 ? 's' : ''}</div>` : ''}
                        </div>
                        <div class="item-meta">
                            ${property.type} â€¢ Created: ${date}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateUserInfo() {
            const user = authService.getCurrentUser();
            const userInfoEl = document.getElementById('userInfo');
            
            if (user) {
                userInfoEl.textContent = `Logged in as ${user.email} (${user.role})`;
            } else {
                userInfoEl.textContent = 'Not authenticated';
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        window.filterLeads = function() {
            if (!dashboard) return;
            const status = document.getElementById('leadStatusFilter').value;
            const searchTerm = document.getElementById('leadSearch').value;
            
            let filtered = dashboard.leads;
            if (status) {
                filtered = dashboard.getLeadsByStatus(status);
            }
            if (searchTerm) {
                filtered = dashboard.searchLeads(searchTerm);
            }
            
            renderLeads(filtered);
        };

        window.searchLeads = function() {
            filterLeads();
        };

        window.filterProperties = function() {
            if (!dashboard) return;
            const status = document.getElementById('propertyStatusFilter').value;
            const searchTerm = document.getElementById('propertySearch').value;
            
            let filtered = dashboard.properties;
            if (status) {
                filtered = dashboard.getPropertiesByStatus(status);
            }
            if (searchTerm) {
                filtered = dashboard.searchProperties(searchTerm);
            }
            
            renderProperties(filtered);
        };

        window.searchProperties = function() {
            filterProperties();
        };

        window.refreshDashboard = async function() {
            if (!dashboard) {
                await initDashboard();
                return;
            }
            
            try {
                await dashboard.loadDashboard();
                renderDashboard();
            } catch (error) {
                showError(`Failed to refresh: ${error.message}`);
            }
        };

        // Listen for auth events
        document.addEventListener('ninja:auth:login', () => {
            initDashboard();
        });

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            initDashboard();
        }
    </script>
</body>
</html>
